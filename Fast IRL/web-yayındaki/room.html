<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast IRL - Yayƒ±n Odasƒ± {{ROOM_ID}}</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .room-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
            color: white;
            padding: 20px;
        }
        
        .room-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .room-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .room-id {
            font-size: 1.125rem;
            color: #9ca3af;
            font-family: 'Courier New', monospace;
        }
        
        .broadcast-area {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .video-container {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .broadcast-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            text-align: center;
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #d1d5db;
        }
        
        .control-group select,
        .control-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }
        
        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .control-group select option {
            background: #1f2937;
            color: white;
        }
        
        .broadcast-button {
            width: 100%;
            padding: 16px 32px;
            font-size: 1.125rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .start-broadcast {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .start-broadcast:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .stop-broadcast {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .stop-broadcast:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        
        .status-indicator {
            text-align: center;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .status-offline {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }
        
        .status-live {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .status-connecting {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .room-links {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .room-links h3 {
            margin-bottom: 16px;
            color: #d1d5db;
            font-size: 1.125rem;
        }
        
        .link-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .link-item input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.875rem;
        }
        
        .link-item button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.3s ease;
        }
        
        .link-item button:hover {
            background: #5a67d8;
        }
        
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #9ca3af;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .back-link:hover {
            color: #d1d5db;
        }
        
        .back-link::before {
            content: '‚Üê ';
            margin-right: 8px;
        }
        
        @media (max-width: 768px) {
            .broadcast-controls {
                grid-template-columns: 1fr;
            }
            
            .room-title {
                font-size: 1.5rem;
            }
            
            .broadcast-area {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="room-container">
        <a href="/" class="back-link">Ana Sayfaya D√∂n</a>
        
        <div class="room-header">
            <h1 class="room-title">Yayƒ±n Odasƒ±</h1>
            <p class="room-id">{{ROOM_ID}}</p>
        </div>
        
        <div class="broadcast-area">
            <div class="video-container">
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
            
            <div id="statusIndicator" class="status-indicator status-offline">
                üî¥ Yayƒ±n Kapalƒ±
            </div>
            
            <div class="broadcast-controls">
                <div class="control-group">
                    <label for="resolutionSelect">√á√∂z√ºn√ºrl√ºk</label>
                    <select id="resolutionSelect">
                        <option value="1280x720">HD (1280x720)</option>
                        <option value="1920x1080" selected>Full HD (1920x1080)</option>
                        <option value="2560x1440">2K (2560x1440)</option>
                        <option value="3840x2160">4K (3840x2160)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="fpsSelect">FPS</label>
                    <select id="fpsSelect">
                        <option value="30">30 FPS</option>
                        <option value="60" selected>60 FPS</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="bitrateInput">Bitrate (Mbps)</label>
                    <input type="number" id="bitrateInput" value="15" min="1" max="50" step="1">
                </div>
            </div>
            
            <button id="broadcastBtn" class="broadcast-button start-broadcast">
                üöÄ Yayƒ±nƒ± Ba≈ülat
            </button>
            
            <div class="room-links">
                <h3>üì§ Payla≈üƒ±m Linkleri</h3>
                <div class="link-item">
                    <input type="text" id="roomUrlInput" readonly value="http://173.249.21.219:8080/room/{{ROOM_ID}}">
                    <button onclick="copyRoomUrl()">üìã</button>
                </div>
                <div class="link-item">
                    <input type="text" id="embedUrlInput" readonly value="http://173.249.21.219:8080/embed/{{ROOM_ID}}">
                    <button onclick="copyEmbedUrl()">üìã</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Room ID'yi al
        const roomId = '{{ROOM_ID}}';
        let isBroadcasting = false;
        let localStream = null;
        let peerConnection = null;
        let ws = null;
        
        // DOM elementleri
        const localVideo = document.getElementById('localVideo');
        const broadcastBtn = document.getElementById('broadcastBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const resolutionSelect = document.getElementById('resolutionSelect');
        const fpsSelect = document.getElementById('fpsSelect');
        const bitrateInput = document.getElementById('bitrateInput');
        
        // Sayfa y√ºklendiƒüinde
        document.addEventListener('DOMContentLoaded', function() {
            // WebSocket baƒülantƒ±sƒ±nƒ± kur
            connectWebSocket();
            
            // Broadcast butonuna tƒ±klandƒ±ƒüƒ±nda
            broadcastBtn.addEventListener('click', toggleBroadcast);
            
            // Kamera eri≈üimi iste
            requestCameraAccess();
        });
        
        // WebSocket baƒülantƒ±sƒ±
        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}`);
            
            ws.onopen = function() {
                console.log('‚úÖ WebSocket baƒülandƒ±');
                // Odaya katƒ±l
                ws.send(JSON.stringify({
                    type: 'join-room',
                    roomId: roomId
                }));
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                console.log('‚ùå WebSocket baƒülantƒ±sƒ± kesildi');
                updateStatus('offline', 'üî¥ Baƒülantƒ± Kesildi');
            };
            
            ws.onerror = function(error) {
                console.error('‚ùå WebSocket hatasƒ±:', error);
                updateStatus('offline', 'üî¥ Baƒülantƒ± Hatasƒ±');
            };
        }
        
        // WebSocket mesajlarƒ±nƒ± i≈üle
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'room-joined':
                    console.log('‚úÖ Odaya katƒ±ldƒ±:', data.roomId);
                    break;
                    
                case 'error':
                    console.error('‚ùå Hata:', data.message);
                    alert('Hata: ' + data.message);
                    break;
                    
                default:
                    console.log('üì® Mesaj alƒ±ndƒ±:', data);
            }
        }
        
        // Kamera eri≈üimi iste
        async function requestCameraAccess() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 60 }
                    },
                    audio: true
                });
                
                localVideo.srcObject = localStream;
                console.log('‚úÖ Kamera eri≈üimi saƒülandƒ±');
                
            } catch (error) {
                console.error('‚ùå Kamera eri≈üimi hatasƒ±:', error);
                alert('Kamera eri≈üimi saƒülanamadƒ±: ' + error.message);
            }
        }
        
        // Yayƒ±nƒ± ba≈ülat/durdur
        async function toggleBroadcast() {
            if (!isBroadcasting) {
                await startBroadcast();
            } else {
                stopBroadcast();
            }
        }
        
        // Yayƒ±nƒ± ba≈ülat
        async function startBroadcast() {
            if (!localStream) {
                alert('Kamera eri≈üimi saƒülanamadƒ±!');
                return;
            }
            
            try {
                updateStatus('connecting', 'üîÑ Baƒülanƒ±yor...');
                
                // WebRTC peer connection olu≈ütur
                peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' }
                    ]
                });
                
                // Local stream'i ekle
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Offer olu≈ütur
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Offer'ƒ± g√∂nder
                ws.send(JSON.stringify({
                    type: 'offer',
                    data: offer
                }));
                
                // ICE candidate'larƒ± g√∂nder
                peerConnection.onicecandidate = function(event) {
                    if (event.candidate) {
                        ws.send(JSON.stringify({
                            type: 'ice-candidate',
                            data: event.candidate
                        }));
                    }
                };
                
                // Yayƒ±n durumunu g√ºncelle
                ws.send(JSON.stringify({
                    type: 'broadcast-status',
                    isLive: true,
                    title: `Yayƒ±n ${roomId}`
                }));
                
                isBroadcasting = true;
                updateStatus('live', 'üî¥ CANLI YAYIN');
                broadcastBtn.textContent = '‚èπÔ∏è Yayƒ±nƒ± Durdur';
                broadcastBtn.className = 'broadcast-button stop-broadcast';
                
                console.log('‚úÖ Yayƒ±n ba≈ülatƒ±ldƒ±');
                
            } catch (error) {
                console.error('‚ùå Yayƒ±n ba≈ülatma hatasƒ±:', error);
                alert('Yayƒ±n ba≈ülatƒ±lamadƒ±: ' + error.message);
                updateStatus('offline', 'üî¥ Yayƒ±n Hatasƒ±');
            }
        }
        
        // Yayƒ±nƒ± durdur
        function stopBroadcast() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            // Yayƒ±n durumunu g√ºncelle
            ws.send(JSON.stringify({
                type: 'broadcast-status',
                isLive: false
            }));
            
            isBroadcasting = false;
            updateStatus('offline', 'üî¥ Yayƒ±n Kapalƒ±');
            broadcastBtn.textContent = 'üöÄ Yayƒ±nƒ± Ba≈ülat';
            broadcastBtn.className = 'broadcast-button start-broadcast';
            
            console.log('‚èπÔ∏è Yayƒ±n durduruldu');
        }
        
        // Durum g√∂stergesini g√ºncelle
        function updateStatus(status, message) {
            statusIndicator.className = `status-indicator status-${status}`;
            statusIndicator.textContent = message;
        }
        
        // Room URL'ini kopyala
        function copyRoomUrl() {
            const roomUrl = document.getElementById('roomUrlInput').value;
            copyToClipboard(roomUrl);
            showToast('Yayƒ±n linki kopyalandƒ±!');
        }
        
        // Embed URL'ini kopyala
        function copyEmbedUrl() {
            const embedUrl = document.getElementById('embedUrlInput').value;
            copyToClipboard(embedUrl);
            showToast('Embed linki kopyalandƒ±!');
        }
        
        // Panoya kopyala
        function copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text);
            } else {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            }
        }
        
        // Toast mesajƒ± g√∂ster
        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 500;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // Sayfa kapatƒ±ldƒ±ƒüƒ±nda yayƒ±nƒ± durdur
        window.addEventListener('beforeunload', function() {
            if (isBroadcasting) {
                stopBroadcast();
            }
        });
    </script>
</body>
</html>
